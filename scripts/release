#!/usr/bin/env bash
set -e

BUMP_TYPE=$1
CURRENT_BRANCH="$(git symbolic-ref --short -q HEAD)"

success() {
  echo -e "\033[32;1m$1\033[0m"
}

error() {
  echo -e "\033[31;1m$1\033[0m"
}

if [ -z "$CURRENT_BRANCH" ]; then
  error "Not in a branch. Stopping release."
  exit 1
fi

if [ -z "$BUMP_TYPE" ]; then
  echo "Detecting recommended bump type..."
  BUMP_TYPE="$(npx conventional-recommended-bump -p angular)"
fi

if [ -z "$BUMP_TYPE" ]; then
  error "Unable to determine version bump type"
  exit 1
fi

# Install deps only when local
if [ -z "$CI" ]; then
  npm install
fi

echo "==> Bumping version ($BUMP_TYPE)"
VERSION="$(npm version --no-git-tag-version "$BUMP_TYPE" | sed 's/v//g')"

# Check npm version
PKG_NAME="$(node -p "require('./package.json').name")"
if npm view "$PKG_NAME@$VERSION" >/dev/null 2>&1; then
  error "Version $VERSION already exists on npm"
  exit 0
fi

echo "==> Updating CHANGELOG"
npx conventional-changelog -i CHANGELOG.md -o CHANGELOG.md -p angular

echo "==> Cleaning build"
rm -rf dist

echo "==> Building"
npm run build

echo "==> Creating release branch"
git checkout -b "release-$VERSION"
git add .
git commit -m "chore(release): $VERSION"
git push origin "release-$VERSION"

success "Release branch release-$VERSION created"
